<!doctype html>
<html lang="en">

 
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="assets/vendor/bootstrap/css/bootstrap.min.css">
    <link href="assets/vendor/fonts/circular-std/style.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/libs/css/style.css">
    <link rel="stylesheet" href="assets/vendor/fonts/fontawesome/css/fontawesome-all.css">
   
   
    <title>Duen-Hotel drinks</title>
 <style>
  body {
  font-family: Arial, sans-serif;
}

.container {
  max-width: 600px;
  margin: 0 auto;
  padding: 20px;
  border: 1px solid #ccc;
  border-radius: 5px;
}

.container h2 {
  text-align: center;
}

form > div {
  margin-bottom: 10px;
}

.container label {
  display: inline-block;

}



button {
  padding: 5px 10px;
  background-color: #007bff;
  color: #fff;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

button:hover {
  background-color: #b35100;
}

#card-display {
  margin-top: 20px;
  width: 300px;

}
 
#myForm input{
    text-align: center;
    

}
center{
width: 100%;}

#myForm th,tr{
    width: 280px;
    text-align: center;
}
#myForm input, label, select,i,th,td{
    font-size:small;
     text-align: center;
            }
#myForm select,input,textarea:focus {
            outline: none;
            border: none; /* Supprime la bordure de focus */

                }

    .calculatesection{
        display: flex;
        width: 300px;
        margin-left: 30px;
    }
   
  .container input{
    width: 100%;
  }
    .calculatesection input{
        width: 60px;
    }
    #invoiceTable{
        width: 300px;
    }
 </style>
</head>

<body>
    <!-- ============================================================== -->
    <!-- main wrapper -->
    <!-- ============================================================== -->
    <div class="dashboard-main-wrapper">
        <!-- ============================================================== -->
        <!-- navbar -->
        <!-- ============================================================== -->
        <div class="dashboard-header">
            <nav class="navbar navbar-expand-lg bg-white fixed-top">
                <a class="navbar-brand" href="home.html">DUEN-HOTEL</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse " id="navbarSupportedContent">
                    <ul class="navbar-nav ml-auto navbar-right-top">
                       
                        <li class="" style=" width: 100%; margin-right: 10px;" >
                            <a  class="nav-link nav-icons" ><button style="width: 100%; background-color: #b35100; border-radius: 50%;" class="fas fa-fw fa-user" id="UserName"></button> </a>
                            
                        </li>
                         
                         
                               
                            </ul>
                       
                </div>
            </nav>
        </div>
        <!-- ============================================================== -->
        <!-- end navbar -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- left sidebar -->
        <!-- ============================================================== -->
        <div class="nav-left-sidebar sidebar-dark" style="width: 350px;">
            <div class="menu-list">
                <nav class="navbar navbar-expand-lg navbar-light">
                   
                    <div class="collapse navbar-collapse" id="navbarNav" >
                       
                         
        <center>
            <div class="card" id="card-display">
                                              
                                          
                <form id="myForm">
                    <center>
                   
                           
                                <h2>DUEN-HOTEL</h2>
                                   <h3 class="info" id="idInvoicedisplay" >
                                    
                                   </h3><br>
                                    
                                    <i class="info">üìç7, Angle des rues A. <br>
                                         Martial & Costa, Delmas 33
                                    </i><br>
                                    
                                    <i class="info">‚òé +509 35 10 1329 <br> / 36 43 7237
                                    </i><br>
                                    <i class="info">üìß duenhotel@gmail.com</i><br>
                                   
                                 
                                            <input type="date" id="dateInvoicedis" required readonly><br>
                                            <input type="time" id="timeInvoicedis" required readonly><br>
                             
                                <input id="fullname" name="choices"  required placeholder="ID">
                             
                               <br>
                           
                               
                                <select  name="choices"  id="paymentmeth" required>
                                    <option value="cash">cash</option>
                                    <option value="check">check</option>
                                    <option value="card">Credit/Debit card</option>
                                    <option value="moncash">moncash</option>
                                  </select>
                            <br>
                        </center><center>
                            <div class="form-group">
                             
                                <div class="productconsommation">
                                    <table id="invoiceTable"  class=" table-striped table-bordered">
                                        <thead >
                                          <tr style="width: 200px;">
                                            <th>Item</th>
                                      
                                            <th>Prx</th>
                                            <th>Cur</th>
                                            <th>Qt</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                         
                                        </tbody>
                                      </table>
                                      
                                </div> 
                            </div>
                          
                           <div class="calculatesection">
                                <label for="pay-onGdes">Pay&eacute; avec Gdes:</label>
                                <input type="number" class="pay-onGdes" placeholder="0.000" value="0" required>
                                </div>
                                <div class="calculatesection">
                                    <label for="pay-onUs">Pay&eacute; avec Us:</label>
                                    <input type="number" class="pay-onUs" placeholder="0.000" value="0" required>
                                    </div>
                             
                             <div class="calculatesection">
                                <label for="changeGdes">Change Gdes:</label>
                                <input type="number" class="changeGdes" placeholder="0.000" required>
                             </div>
                           
                           <div class="calculatesection">
                           <label for="changeUs">Change Us:</label>
                                <input type="number" class="changeUs" placeholder="0.000" required>
                           </div>
                           
    
                           <div class="calculatesection">
                                <label for="totalGdes">Total Gdes</label>
                                <input type="number" class="totalGdes" placeholder="0.000" step="0.01" min="0" max="100000" required readonly><br>
                           </div>
                           <div class="calculatesection">
                                <label for="totalUs">Total Us</label>
                                <input type="number" class="totalUs" placeholder="0.000" step="0.01" min="0" max="100000" required readonly>
                           </div>
                           <div class="calculatesection">   
                                <label for="back">Balance Gdes</label>
                                <input type="number" class="balanceGdes" placeholder="0.000" step="0.01" min="0" max="100000" required>
                           </div>
                           <div class="calculatesection">
                                 <label for="balanceUs">Balance Us</label>
                                 <input type="number" class="balanceUs" placeholder="0.000" step="0.01" min="0" max="100000" required>
                           </div>
                                <br>
                           <select  name="choices"  id="paymentStatut" required>
                            <option value="check">NON PAY&Eacute;</option>
                            <option value="cash">PAY&Eacute;</option>
                            
                            <option value="card">CREDIT&Eacute;</option>
                            
                          </select><br>
                    
                               
                                <input type="text" class="vendeur" id="sellerNameInvoicedis" placeholder="Vendeur" required readonly><br>
                         
                           
    
                            </center> 
             
                </form>
           
                
                    <button id="Confirm" class="newcustomer"> Confirm</button>
                
                
                    <button id="print" class="newcustomer" onclick="generatePDF();"> print</button>
                
               
    
            </div>
        </center>
            
                    
                    </div>
                </nav>
            </div>
        </div>
        <!-- ============================================================== -->
        <!-- end left sidebar -->
        <!-- ============================================================== -->
        <!-- wrapper  -->
        <!-- ============================================================== -->
        <div class="dashboard-wrapper" style="margin-left: 350px;">
            <div class="influence-profile">
                <div class="container-fluid dashboard-content ">
                    <!-- ============================================================== -->
                    <!-- pageheader -->
                    <!-- ============================================================== -->
                    <div class="row">
                        <div class="col-xl-8 col-lg-8 col-md-8 col-sm-8 col-8">
                            <div class="page-header">
                                <h3 class="mb-2">ORDER Dashboard </h3>
                                <p class="pageheader-text">Proin placerat ante duiullam scelerisque a velit ac porta, fusce sit amet vestibulum mi. Morbi lobortis pulvinar quam.</p>
                                <div class="page-breadcrumb">
                                    <nav aria-label="breadcrumb">
                                        <ol class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="#" class="breadcrumb-link">Dashboard</a></li>
                                            <li class="breadcrumb-item active" aria-current="page">Duen-Hotel Sale</li>
                                        </ol>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                    <style>
                       
                       
                       
                        #cardHidden{
                          display: none;
                       }
                    </style>
                    <!-- ============================================================== -->
                    <!-- end pageheader -->
                    <!-- ============================================================== -->
                    <!-- ============================================================== -->
                    <!-- content -->
                    <!-- ============================================================== -->

                    <button id="addBtn">Ajouter Facture</button>
                    <div class="container" id="cardHidden">
                      <h2>Enregistrement des Ventes</h2>
                      <form id="salesForm">
                        <div>
                          <label for="date">Date:</label>
                          <input type="date" id="date" name="date" required>
                         
                        </div>
                        <div>
                           
                            <label for="timeInvoice">Time:</label>
                            <input type="time" id="timeInvoice" name="timeInvoice" required><br>
                          </div>

                        <div>
                          <label for="invoiceId">Id:</label>
                          <input type="text" id="idInvoice" name="idInvoice" required><br><br>
                          <button for="priceChoice" id="foundInvoice" type="button">Trouver Facture</button>
                          
                        </div>
                        <div>
                          <label for="name">Nom du Client:</label>
                          <input type="text" id="name" name="name" required>
                        </div>
                        <div>
                          <label for="sellerName">Nom du Vendeur:</label>
                          <input type="text" id="sellerName" name="sellerName" required readonly>
                        </div>
                        <div>
                          <label for="product">Produit:</label>
                          <input type="text" id="product" name="product" list="productList" required>
                          <datalist id="productList"></datalist>
                          <div>
                            <label for="category">Category:</label>
                            <input type="text" id="category" name="category"  required>
                          </div>
                          <div><br>
                            <button for="priceChoice" id="priceChoice1" type="button">Afficher les Prix:</button>
                            <select id="priceChoice" name="priceChoice" required>
                             
                            </select>
                          </div>
                          <div>
                            <label for="quantity">Quantit√©:</label>
                            <input type="number" id="quantity" name="quantity" min="1" required>
                            <input type="text" id="currencyChoice" hidden>
                          </div>
                          <br>
                          <button for="priceChoice" id="addProductOnTable" type="button">Inserer le produit:</button>
                          <button id="deleteRow" class="newcustomer" type="button"> Suprimer le dernier produit</button><br>
                          <table class="table table-striped table-bordered first" id="productConsumed">
                            <thead>
                              <tr>
                                 
                                  <th>Item</th>
                                  <th>quantity</th>
                                  <th>Price</th>
                                 
                                  <th>Currency</th>
                                  <th>Category</th>
                                  
                              </tr>
                          </thead>
                          <tbody id="consumedTableBody">
                              <!-- Les lignes de tableau seront ins√©r√©es ici -->
                            
                          </tbody>
                            
                          </table>
                        </div>
                        <label for="totalGdesToPay">Total Gdes</label>
                       <input type="number" name="totalGdesToPay" id="totalGdesToPay" step="0.01" min="0" max="100000" readonly><br>
                       <label for="totalUsToPay">Total Us</label>
                       <input type="number" name="totalUsToPay" id="totalUsToPay" step="0.01" min="0" max="100000" readonly><br><br>
                       <button id="caluculate" type="button">Calculer</button>
                        
                       <center><button type="button" id="addProduct">Enregistrer La Facture</button></center> 
                      </form><br><br>
                      <center><button id="closeForm">Close Form</button></center>
                  </div>
                  

                  <div class="table-responsive">
                                   
                                      
                    <table class="table table-striped table-bordered first" id="invoicesTable">
                      <thead>
                        <tr>
                            <th>Invoice ID</th>
                            <th>Name</th>
                            <th>Total Products</th>
                            <th>Total Gdes</th>
                            <th>Total US</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody >
                        <!-- Les lignes de tableau seront ins√©r√©es ici -->
                    </tbody>
                      
                    </table>
                </div>
                        <!-- ============================================================== -->
                        <!-- end campaign data -->
                        <!-- ============================================================== -->
                    </div>
                </div>
            </div>
        
        </div>
      
        <!-- ============================================================== -->
        <!-- end wrapper -->
        <!-- ============================================================== -->
    </div>
   
      
    
    <!-- Ajoutez ces scripts avant la fermeture de la balise body -->

    <script src="https://konbitmarket.netlify.app/js/js/firebase-app.js"></script>
    <script src="https://konbitmarket.netlify.app/js/js/auth.js"></script>
    <script src="https://konbitmarket.netlify.app/js/js/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    <script>
         const cardHidden = document.querySelector("#cardHidden");
    const addBtn = document.querySelector("#addBtn");
    const closeform = document.querySelector("#closeForm");
    addBtn.addEventListener("click", (e) => {
      cardHidden.style.display="block";
      
      
    });

    closeform.addEventListener("click", (e) => {
      cardHidden.style.display="none";
      
    });
    </script>

    <script>
        document.getElementById('caluculate').addEventListener('click', function() {
    // Initialisation des variables pour stocker les totaux
    let totalGdesToPay = 0;
    let totalUsToPay = 0;
    
    // S√©lectionner toutes les lignes du tableau
    const rows = document.querySelectorAll('#consumedTableBody tr');

    // Cr√©er un objet pour stocker les quantit√©s par devise
    const quantitiesByCurrency = {};

    // Parcourir chaque ligne du tableau
    rows.forEach(row => {
        const item = row.cells[0].textContent;
        const quantity = parseInt(row.cells[1].querySelector('input').value);
        const price = parseFloat(row.cells[2].textContent);
        const currency = row.cells[3].textContent;

        // Ajouter la quantit√© √† la devise correspondante
        if (!quantitiesByCurrency[currency]) {
            quantitiesByCurrency[currency] = 0;
        }
        quantitiesByCurrency[currency] += quantity * price;

        // Calculer les totaux en fonction de la devise
        if (currency === 'Gdes') {
            totalGdesToPay += quantity * price;
        } else if (currency === 'Us') {
            totalUsToPay += quantity * price;
        }
    });

    // Mettre √† jour les champs de total
    document.getElementById('totalGdesToPay').value = totalGdesToPay;
    document.getElementById('totalUsToPay').value = totalUsToPay;
});

    </script>

<script>
      

    // Get current date
    const today = new Date();
  
    // Format date to 'YYYY-MM-DD' (required by HTML date input)
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const formattedDate = `${year}-${month}-${day}`;
  
    // Set the value of the input field to the current date
    document.getElementById('date').value = formattedDate;
      </script>

<script>
  
  
    // Format time to 'HH:MM' (required by HTML time input)
    const hours = String(today.getHours()).padStart(2, '0');
    const minutes = String(today.getMinutes()).padStart(2, '0');
    const formattedTime = `${hours}:${minutes}`;
  
    // Set the value of the input field to the current time
    document.getElementById('timeInvoice').value = formattedTime;
</script>


  <script>
const salesForm = document.getElementById('salesForm');
const addProductButton = document.getElementById('addProduct');
const salesTable = document.getElementById('salesTable');
const productNameInput = document.getElementById('product');
const productList = document.getElementById('productList');
const priceChoiceSelect = document.getElementById('priceChoice');
const priceChoiceSelect1 = document.getElementById('priceChoice1');



// Fonction pour r√©cup√©rer les produits correspondant au pr√©fixe et les afficher dans la liste de suggestions
async function fetchAndDisplayProducts() {
  const prefix = productNameInput.value.trim();
  const querySnapshot = await db.collection('DrinkStock').where('name', '>=', prefix)
                                                        .where('name', '<=', prefix + '\uf8ff').get();
  productList.innerHTML = ''; // Vider les options existantes
  querySnapshot.forEach(doc => {
    const productName = doc.data().name;
    const option = document.createElement('option');
    option.value = productName;
    productList.appendChild(option);
  });
}

// Tableau pour stocker les produits consomm√©s
let productsConsumed = [];
// Fonction pour v√©rifier si le produit existe et afficher ses prix comme options dans le champ priceChoice
async function checkProductAndDisplayPrices() {
    const productName = productNameInput.value.trim();
    const productRef = db.collection('DrinkStock').where('name', '==', productName);
    
    try {
        const snapshot = await productRef.get();
        if (snapshot.empty) {
            alert('Le produit s√©lectionn√© n\'existe pas.');
            return;
        }
        
        snapshot.forEach(doc => {
            const productData = doc.data();
            priceChoiceSelect.innerHTML = ''; // Vider les options existantes
            
            // Afficher les options de prix dans le champ priceChoice
            const option1 = document.createElement('option');
            option1.value = productData.priceGdes;
            option1.textContent = `Gourdes: ${productData.priceGdes.toString()} Gdes`;
            
            const option2 = document.createElement('option');
            option2.value = productData.priceUs;
            option2.textContent = `US: ${productData.priceUs.toString()} US`;
            
            priceChoiceSelect.appendChild(option1);
            priceChoiceSelect.appendChild(option2);

            // Afficher la cat√©gorie dans l'input avec l'ID 'category'
            const categoryInput = document.getElementById('category');
            categoryInput.value = productData.category || '';
            const currencyInput = document.getElementById('currencyChoice');
            const selectedIndex = priceChoiceSelect.selectedIndex;
            const selectedCurrency = selectedIndex === 0 ? 'Gdes' : 'Us';
            currencyInput.value = selectedCurrency;
        });

        // Ajouter un √©couteur d'√©v√©nements pour le changement d'option dans priceChoiceSelect
        priceChoiceSelect.addEventListener('change', () => {
            const currencyInput = document.getElementById('currencyChoice');
            const selectedIndex = priceChoiceSelect.selectedIndex;
            const selectedCurrency = selectedIndex === 0 ? 'Gdes' : 'Us';
            currencyInput.value = selectedCurrency;
        });
    } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration des informations du produit :', error);
    }
}

// Ajouter un produit au tableau
addProductOnTable.addEventListener('click', () => {
    // R√©cup√©rer les valeurs des champs
    const productName = document.getElementById('product').value.trim();
    
    const category = document.getElementById('category').value.trim();
    const quantity = parseInt(document.getElementById('quantity').value.trim());
    const price = parseFloat(document.getElementById('priceChoice').value.trim());
    const currency = document.getElementById('currencyChoice').value.trim();

    // V√©rifier si tous les champs n√©cessaires sont remplis
    if (!productName || !category || isNaN(quantity) || isNaN(price) || !currency) {
        alert('Veuillez remplir tous les champs n√©cessaires.');
        return;
    }


    // V√©rifier si le produit existe d√©j√† dans le tableau avec la m√™me devise
    const existingProductIndex = productsConsumed.findIndex(product => product.name === productName && product.currency === currency);

    if (existingProductIndex !== -1) {
        // Le produit existe d√©j√† avec la m√™me devise, mettre √† jour la quantit√© et le total
        const existingProduct = productsConsumed[existingProductIndex];
        existingProduct.quantity = quantity;
        existingProduct.total = total;

        // Mettre √† jour la ligne du tableau HTML
        const tableBody = document.getElementById('consumedTableBody');
        const row = tableBody.rows[existingProductIndex];
        row.cells[1].innerHTML = `<input type="number" value="${quantity}" min="1">`;
      
    } else {
        // Le produit n'existe pas encore avec la m√™me devise, l'ajouter au tableau
        productsConsumed.push({
            name: productName,
            quantity: quantity,
            price: price,
          
            currency: currency,
            category: category
        });

        // Ajouter une nouvelle ligne au tableau HTML
        const tableBody = document.getElementById('consumedTableBody');
        const row = tableBody.insertRow();
        row.insertCell().textContent = productName;
        row.insertCell().innerHTML = `<input type="number" value="${quantity}" min="1">`;
        row.insertCell().textContent = price;
       
        row.insertCell().textContent = currency;
        row.insertCell().textContent = category;
    }
});

// √âcouter les changements dans le champ de saisie du produit
productNameInput.addEventListener('input', fetchAndDisplayProducts);

// Ajouter un √©couteur d'√©v√©nements pour le clic sur le champ priceChoice
priceChoiceSelect1.addEventListener('click', checkProductAndDisplayPrices);

// Ajouter un √©couteur d'√©v√©nements pour le bouton "Ajouter Produit"
// Ajouter un √©couteur d'√©v√©nements pour le bouton "Ajouter Produit"
addProductButton.addEventListener('click', async () => {
    const formData = new FormData(salesForm);
    var invoiceId = formData.get('idInvoice');
    const productRows = document.querySelectorAll('#productConsumed tbody tr');

    const sellerNameInput = document.getElementById('sellerName');
    const nameInput = document.getElementById('name');
    const totalGdsinput = document.getElementById('totalGdesToPay');
    const totalUsinput = document.getElementById('totalUsToPay');

    // V√©rifier si les champs sellerName et name ne sont pas vides
    if (sellerNameInput.value.trim() === '' || totalUsinput.value.trim() === '' ) {
        alert('Veuillez remplir tous les champs obligatoires.');
        return; // Arr√™ter l'ex√©cution de la fonction si les champs sont vides
    }

    if (totalGdsinput.value.trim() === '' || nameInput.value.trim() === '' ) {
        alert('Veuillez remplir tous les champs obligatoires.');
        return; // Arr√™ter l'ex√©cution de la fonction si les champs sont vides
    }

    // V√©rifier si l'ID de la facture est vide
    if (!invoiceId) {
        // G√©n√©rer un ID automatique pour la facture
        invoiceId = generateInvoiceId();
    }

    // Tableau pour stocker les produits
    const products = [];

    // Parcourir les lignes du tableau pour collecter les informations sur chaque produit
    productRows.forEach(row => {
        const productName = row.cells[0].textContent.trim();
        const quantity = parseInt(row.cells[1].querySelector('input').value.trim()); // Utiliser querySelector pour obtenir l'input
        const productPrice = parseFloat(row.cells[2].textContent.trim());
       
        const priceCurrency = row.cells[3].textContent.trim();
        const category = row.cells[4].textContent.trim();

        // Ajouter les informations du produit au tableau de produits
        products.push({
            name: productName,
            quantity: quantity,
            productPrice: productPrice,
       
            priceCurrency: priceCurrency,
            category: category, // Vous devez r√©cup√©rer la cat√©gorie du produit de DrinkStock
        });
    });

    // R√©f√©rence √† la collection globalSales
    const globalSalesRef = db.collection('globalSales');

    try {
        // Rechercher la facture avec l'ID de la facture sp√©cifi√©
        const querySnapshot = await globalSalesRef.where('invoiceId', '==', invoiceId).get();

        if (querySnapshot.empty) {
            // La facture avec cet ID n'existe pas, ajouter une nouvelle vente
            await addNewSale(formData, products, invoiceId);
        } else {
            // La facture avec cet ID existe, mettre √† jour la vente
            await updateExistingSale(querySnapshot, formData, products);
        }

        // Afficher les donn√©es des ventes
        displaySalesData();

        // R√©initialiser le formulaire
        salesForm.reset();
        window.location.href = 'orderinvoice.html';
        console.log('Vente ajout√©e ou mise √† jour avec succ√®s dans Firestore');
    } catch (error) {
        console.error('Erreur lors de l\'ajout ou de la mise √† jour de la vente dans Firestore :', error);
    }
});

// Fonction pour ajouter une nouvelle vente


// Fonction pour soustraire la quantit√© de produits vendus de la quantit√© disponible dans la collection DrinkStock
async function subtractQuantityFromDrinkStock(productName, quantity) {
    const drinkStockRef = db.collection('DrinkStock');
    const snapshot = await drinkStockRef.where('name', '==', productName).get();
    if (!snapshot.empty) {
        snapshot.forEach(doc => {
            const productData = doc.data();
            const availableQuantity = productData.quantity;
            const updatedQuantity = availableQuantity - quantity;
            doc.ref.update({ quantity: updatedQuantity });
        });
    }
}

// Fonction pour ajouter la quantit√© de produits vendus √† la quantit√© disponible dans la collection DrinkStock
async function addQuantityToDrinkStock(productName, quantity) {
    const drinkStockRef = db.collection('DrinkStock');
    const snapshot = await drinkStockRef.where('name', '==', productName).get();
    if (!snapshot.empty) {
        snapshot.forEach(doc => {
            const productData = doc.data();
            const availableQuantity = productData.quantity;
            const updatedQuantity = availableQuantity + quantity;
            doc.ref.update({ quantity: updatedQuantity });
        });
    }
}

// Fonction pour ajouter une nouvelle vente
async function addNewSale(formData, products, invoiceId) {
    // R√©f√©rence √† la collection globalSales
    const globalSalesRef = db.collection('globalSales');
    
    try {
        // Parcourir les produits de la facture
        for (const product of products) {
            await subtractQuantityFromDrinkStock(product.name, product.quantity);
        }

        // Cr√©er un objet pour la nouvelle vente avec le tableau de produits
        const newSale = {
            date: formData.get('date'),
            time: formData.get('timeInvoice'),
            name: formData.get('name'),
            sellerName: formData.get('sellerName'),
            invoiceId: invoiceId,
            totalGdes: formData.get('totalGdesToPay'),
            totalUs: formData.get('totalUsToPay'),
            products: products,
        };

        // Ajouter la vente dans Firestore
        await globalSalesRef.add(newSale);

        console.log('Nouvelle vente ajout√©e avec succ√®s √† Firestore');

        // R√©initialiser le tableau productsPreference
        productsPreference = [];

        // R√©cup√©rer √† nouveau les donn√©es de la facture
        const querySnapshot = await globalSalesRef.where('invoiceId', '==', invoiceId).get();
        if (!querySnapshot.empty) {
            querySnapshot.forEach(doc => {
                const saleData = doc.data();
                saleData.products.forEach(product => {
                    productsPreference.push({
                        name: product.name,
                        quantity: product.quantity,
                        price: product.productPrice,
                     
                        currency: product.priceCurrency,
                        category: product.category
                    });
                });
            });

            
        }
    } catch (error) {
        console.error('Erreur lors de l\'ajout de la nouvelle vente √† Firestore :', error);
    }
}

// Fonction pour mettre √† jour une vente existante
async function updateExistingSale(querySnapshot, formData, products) {
    try {
        // Prendre la premi√®re facture trouv√©e (il ne devrait y avoir qu'une seule facture avec cet ID)
        const doc = querySnapshot.docs[0];
        const saleData = doc.data();
        

        // Parcourir les produits de la facture avant la mise √† jour
        for (const existingProduct of saleData.products) {
            const updatedProduct = products.find(product => product.name === existingProduct.name);
            if (updatedProduct) {
                const quantityDifference = updatedProduct.quantity - existingProduct.quantity;
                if (quantityDifference > 0) {
                    await subtractQuantityFromDrinkStock(updatedProduct.name, quantityDifference);
                } else if (quantityDifference < 0) {
                    await addQuantityToDrinkStock(updatedProduct.name, Math.abs(quantityDifference));
                }
            }
        }

        // Pour les nouveaux produits ajout√©s √† la facture, soustraire leur quantit√© de la quantit√© disponible dans la collection DrinkStock
        for (const updatedProduct of products) {
            const existingProduct = saleData.products.find(product => product.name === updatedProduct.name);
            if (!existingProduct) {
                await subtractQuantityFromDrinkStock(updatedProduct.name, updatedProduct.quantity);
            }
        }

        // Mettre √† jour la facture dans Firestore avec les donn√©es mises √† jour
        await doc.ref.update({
            products: products,
            name: formData.get('name'), // Mettre √† jour le nom de la vente
            totalGdes: formData.get('totalGdesToPay'),
            totalUs: formData.get('totalUsToPay'),
            sellerName: formData.get('sellerName'), // Mettre √† jour le nom du vendeur
            
            
        });

        console.log('Vente mise √† jour avec succ√®s dans Firestore');
    } catch (error) {
        console.error('Erreur lors de la mise √† jour de la vente dans Firestore :', error);
    }
}


// Fonction pour g√©n√©rer un ID automatique pour la facture
function generateInvoiceId() {
    const randomFourDigits = Math.floor(1000 + Math.random() * 9000); // G√©n√©rer un nombre al√©atoire entre 1000 et 9999
    return `DH${randomFourDigits}`; // Format de l'ID automatique
}



  </script>



<script>
    // R√©f√©rence √† la collection globalSales
  const globalSalesRef = db.collection('globalSales');
  
  // R√©f√©rence au champ idInvoice et au bouton foundInvoice
  const idInvoiceInput = document.getElementById('idInvoice');
  const foundInvoiceButton = document.getElementById('foundInvoice');
  const nameInput = document.getElementById('name');
  const sellerNameInput = document.getElementById('sellerName');
  
  // Tableau de pr√©f√©rence pour stocker les donn√©es des produits
  let productsPreference = [];
  
  // √âcouteur d'√©v√©nements pour le bouton foundInvoice
  foundInvoiceButton.addEventListener('click', async () => {
      const invoiceId = idInvoiceInput.value.trim();
  
      // V√©rifier si l'invoiceId est vide
      if (invoiceId === '') {
          alert('Veuillez saisir un invoiceId.');
          return;
      }
  
      try {
          // R√©initialiser le tableau de pr√©f√©rence
          productsPreference = [];
  
          // Rechercher la facture avec l'invoiceId sp√©cifi√©
          const querySnapshot = await globalSalesRef.where('invoiceId', '==', invoiceId).get();
  
          // V√©rifier si une facture correspondante a √©t√© trouv√©e
          if (querySnapshot.empty) {
              alert('Aucune facture trouv√©e avec cet invoiceId.');
              return;
          }
  
          // Remplir le tableau de pr√©f√©rence avec les donn√©es des produits de la facture trouv√©e
          querySnapshot.forEach(doc => {
              const saleData = doc.data();
              // Ajouter les donn√©es des produits √† la variable productsPreference
              saleData.products.forEach(product => {
                  productsPreference.push({
                      name: product.name,
                      quantity: product.quantity,
                      price: product.productPrice,
                     
                      currency: product.priceCurrency,
                      category: product.category
                  });
              });
              // Remplir les champs d'entr√©e avec le nom du client et le nom du vendeur
              nameInput.value = saleData.name;
              sellerNameInput.value = saleData.sellerName;
          });
  
          // Afficher les donn√©es des produits dans le tableau (vous pouvez modifier cette partie selon votre structure HTML)
          const tableBody = document.getElementById('consumedTableBody');
          tableBody.innerHTML = ''; // R√©initialiser le corps du tableau
  
          productsPreference.forEach(product => {
              const row = document.createElement('tr');
              row.innerHTML = `
                  <td>${product.name}</td>
                  <td><input type="number" value="${product.quantity}"></td>
                  <td>${product.price}</td>
                 
                  <td>${product.currency}</td>
                  <td>${product.category}</td>
              `;
              tableBody.appendChild(row);
          });
  
          console.log('Donn√©es des produits affich√©es avec succ√®s dans le tableau.');
      } catch (error) {
          console.error('Erreur lors de la recherche de la facture ou de l\'affichage des donn√©es des produits :', error);
      }
  });



  
  </script>
  


 

 
<script>

// Fonction pour afficher les d√©tails de la facture lors du clic sur Checkout
async function showInvoiceDetails(invoiceId) {
    try {
        const invoiceRef = db.collection('globalSales').doc(invoiceId);
        const invoiceDoc = await invoiceRef.get();
        const invoiceData = invoiceDoc.data();
        
        // Remplir les champs avec les d√©tails de la facture
        document.getElementById('dateInvoicedis').value = invoiceData.date;
        document.getElementById('timeInvoicedis').value = invoiceData.time;
        document.getElementById('idInvoicedisplay').textContent = `Invoice Id: ${invoiceData.invoiceId}`;
        document.getElementById('fullname').value = invoiceData.name;
        document.getElementById('sellerNameInvoicedis').value = invoiceData.sellerName;
        document.querySelector('.totalGdes').value = invoiceData.totalGdes;
        document.querySelector('.totalUs').value = invoiceData.totalUs;

        // Afficher la liste des produits dans le tableau
        const tableBody = document.querySelector('#invoiceTable tbody');
        tableBody.innerHTML = '';
        invoiceData.products.forEach(product => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${product.name}</td>
                <td>${product.productPrice}</td>
                <td>${product.priceCurrency}</td>
                <td>${product.quantity}</td>
            `;
        });

        // Calculer et remplir les autres champs
        // ...
    } catch (error) {
        console.error('Erreur lors de l\'affichage des d√©tails de la facture :', error);
    }
}
async function displaySalesData() {
    try {
        const globalSalesRef = db.collection('globalSales');
        const todayDate = new Date(); // Obtenir la date d'aujourd'hui
        
        // Formater la date d'aujourd'hui dans le format 'YYYY-MM-DD'
        const todayDateString = todayDate.toISOString().split('T')[0]; 
        
        const querySnapshot = await globalSalesRef
            .where('date', '==', todayDateString) // Comparaison directe avec la cha√Æne de date
            .get();
        
        const tableBody = document.querySelector('#invoicesTable tbody');
        tableBody.innerHTML = '';

        querySnapshot.forEach(async doc => {
            const invoiceData = doc.data();
            const totalProduct = calculateTotalProduct(invoiceData.products);
            const totalGdes = await calculateTotalByCategory(invoiceData.products, 'Gdes');
            const totalUs = await calculateTotalByCategory(invoiceData.products, 'Us');

            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${invoiceData.invoiceId}</td>
                <td>${invoiceData.name}</td>
                <td>${totalProduct}</td>
                <td>${totalGdes}</td>
                <td>${totalUs}</td>
                <td><button class="checkout-button" onclick="showInvoiceDetails('${doc.id}')">Checkout</button></td>
            `;
        });
    } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration des factures :', error);
    }
}

// Fonction pour calculer le total des produits dans une facture
function calculateTotalProduct(products) {
    let total = 0;
    products.forEach(product => {
        total += product.quantity;
    });
    return total;
}

// Fonction pour calculer le total par cat√©gorie (Gdes ou Us) dans une facture
async function calculateTotalByCategory(products, priceCurrency) {
    let total = 0;
    for (const product of products) {
        if (product.priceCurrency === priceCurrency) {
            total += product.quantity * product.productPrice; // Multiplication par le prix du produit
        }
    }
    return total;
}

displaySalesData();

</script>


    <script src="htmltopdf.js"></script>

 <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>
    function generatePDF() {
      const element = document.getElementById('myForm');
  
      // Options pour la conversion en PDF
      const options = {
        margin: 0,
        filename: 'order.pdf',
        image: { type: 'jpeg', quality: 1 }, // Augmenter la qualit√© de l'image
        html2canvas: { scale: 2 }, // Augmenter l'√©chelle
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
  
      // Conversion de l'√©l√©ment en PDF
      html2pdf()
        .from(element)
        .set(options)
        .save();
    }
  </script>



<script>
    document.getElementById('Confirm').addEventListener('click', function() {
    // R√©cup√©rer les totaux Gdes et Us
    const totalGdes = parseFloat(document.querySelector('.totalGdes').value);
    const totalUs = parseFloat(document.querySelector('.totalUs').value);
    
    // R√©cup√©rer les montants pay√©s en Gdes et en Us
    const payOnGdes = parseFloat(document.querySelector('.pay-onGdes').value);
    const payOnUs = parseFloat(document.querySelector('.pay-onUs').value);
    
    // V√©rifier si le montant pay√© est inf√©rieur au total pour calculer la balance
    let balanceGdes = 0;
    let balanceUs = 0;

    let changeGdes = 0;
    let changeUs = 0;

    if (payOnGdes < totalGdes) {
        balanceGdes = totalGdes - payOnGdes;
    }
    if (payOnUs < totalUs) {
        balanceUs = totalUs - payOnUs;
    }

    if (payOnGdes == 0) {
        balanceGdes = totalGdes;
    }
    if (payOnUs == 0) {
        balanceUs = totalUs;
    }
    
    if (payOnGdes > totalGdes) {
        changeGdes = payOnGdes-totalGdes;
    }
    if (payOnUs > totalUs) {
        changeUs = payOnUs-totalUs;
    }
   
    // Mettre √† jour les champs avec les calculs
    document.querySelector('.balanceGdes').value = balanceGdes;
    document.querySelector('.balanceUs').value = balanceUs;
    document.querySelector('.changeGdes').value = changeGdes;
    document.querySelector('.changeUs').value = changeUs;
});

</script>
  
   <script>
 


// Attente du chargement du DOM
document.addEventListener('DOMContentLoaded', function () {
    // R√©cup√©ration du bouton Confirm
    const confirmButton = document.getElementById('Confirm');

    // Ajout d'un gestionnaire d'√©v√©nement sur le clic du bouton Confirm
    confirmButton.addEventListener('click', function () {
        // R√©cup√©ration de la valeur du champ idInvoice
        const idInvoiceElement = document.getElementById('idInvoicedisplay');
        const idInvoice = idInvoiceElement.textContent.trim();
        
        // Recherche du document dans la collection globalesales
        db.collection('globalSales').where('idInvoice', '==', idInvoice).get()
            .then(querySnapshot => {
                if (!querySnapshot.empty) {
                    querySnapshot.forEach(doc => {
                        const documentId = doc.id;
                        const documentData = doc.data();

                        // V√©rification de l'existence des champs statut et paymentmethod
                        if (documentData.hasOwnProperty('statut') && documentData.hasOwnProperty('paymentmethod')) {
                            // Mise √† jour des valeurs des champs statut et paymentmethod avec les valeurs des selects respectifs
                            const paymentMethodSelect = document.getElementById('paymentmeth');
                            const paymentStatutSelect = document.getElementById('paymentStatut');
                            const newPaymentMethod = paymentMethodSelect.value;
                            const newPaymentStatut = paymentStatutSelect.value;

                            return db.collection('globalSales').doc(documentId).update({
                                paymentmethod: newPaymentMethod,
                                statut: newPaymentStatut
                            });
                        } else {
                            // Enregistrement des valeurs des selects respectifs
                            const paymentMethodSelect = document.getElementById('paymentmeth');
                            const paymentStatutSelect = document.getElementById('paymentStatut');
                            const paymentMethod = paymentMethodSelect.value;
                            const paymentStatut = paymentStatutSelect.value;

                            return db.collection('globalSales').doc(documentId).update({
                                paymentmethod: paymentMethod,
                                statut: paymentStatut
                            });
                        }
                    });
                } else {
                    console.log("Aucun document trouv√© avec l'ID de facture sp√©cifi√©.");
                }
            })
            .catch(error => {
                console.error("Erreur lors de la r√©cup√©ration du document :", error);
            });
    });
});

   </script>  


<script>
    // V√©rifier si l'utilisateur est connect√©
firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
        // Utilisateur connect√©
        const userId = user.uid;
        
        // R√©cup√©rer le nom de l'utilisateur √† partir de la collection 'users'
        db.collection('users').doc(userId).get()
            .then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    const sellerNameInput = document.getElementById('sellerName');
                    const UserName = document.getElementById('UserName');
                    UserName.textContent = userData.name;
                    if (sellerNameInput) {
                        sellerNameInput.value = userData.name; // Remplir l'input avec le nom de l'utilisateur
                    }
                } else {
                    console.error('Aucun document trouv√© pour cet utilisateur.');
                }
            })
            .catch(error => {
                console.error('Erreur lors de la r√©cup√©ration des donn√©es de l\'utilisateur:', error);
            });
    } else {
        // Utilisateur non connect√©, rediriger vers la page d'index
        window.location.href = 'index.html';
    }
});

</script>
<script src="addrow.js"></script>
<!-- Ajoutez jQuery √† votre page si ce n'est pas d√©j√† fait -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>



<script>
    $(document).ready(function() {
   
  
      $("#deleteRow").click(function() {
        $("#productConsumed tbody tr:last").remove();
      });
    });
  </script>
   
</body>
 
</html>