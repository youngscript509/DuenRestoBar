<!doctype html>
<html lang="en">


<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="assets/vendor/bootstrap/css/bootstrap.min.css">
    <link href="assets/vendor/fonts/circular-std/style.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/libs/css/style.css">
    

    <meta name="generator" content="DuenInvoice v1.0, https://dueninvoice.netlify.app">
    <link rel="canonical" href="https://dueninvoice.netlify.app">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image:src" content="https://dueninvoice.netlify.app/logo.png">
    <meta property="og:image" content="https://dueninvoice.netlify.app/logo.png">
    <meta name="twitter:title" content="Home">
    <script>
    </script>
   
    <meta name="description" content="Duen Invoice">
    <meta property="og:title" content="Duen">
    <meta property="og:description" content="DuenInvoice">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://dueninvoice.netlify.app/logo.png">
    <meta property="og:image" content="https://dueninvoice.netlify.app/logo.png">
    <meta property="og:locale" content="fr_FR">
    
    <link rel="stylesheet" href="assets/vendor/fonts/fontawesome/css/fontawesome-all.css">


    <title>Duen-Hotel drinks</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        td input {
            width: 70px;
            height: 100%;
        }

        .container h2 {
            text-align: center;
        }

        form>div {
            margin-bottom: 10px;
        }

        .container label {
            display: inline-block;
        }

        button {
            padding: 5px 10px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        button:hover {
            background-color: #b35100;
        }

        #card-display {
            margin-top: 20px;
            width: 300px;
        }

        #myForm input {
            text-align: center;
        }

        center {
            width: 100%;
        }

        #myForm th,
        tr {
            width: 175px;
            text-align: center;
        }

        #myForm th,
        td {
            font-size: 12px;
            text-align: center;
        }

        #myForm select,
        input,
        textarea:focus {
            outline: none;
            border: none;
            /* Supprime la bordure de focus */
        }

        .calculatesection {
            display: flex;
            width: 175px;
            margin-left: 10px;
        }

        .calculatesection input {
            width: 60px;
        }

        #productConsumed th:nth-child(5),
        #productConsumed td:nth-child(5) {
            display: none;
        }

        #productConsumed {
            width: 200px;
        }
    </style>
</head>

<body>
    <!-- ============================================================== -->
    <!-- main wrapper -->
    <!-- ============================================================== -->
    <div class="dashboard-main-wrapper">
        <!-- ============================================================== -->
        <!-- navbar -->
        <!-- ============================================================== -->
        <div class="dashboard-header">
            <nav class="navbar navbar-expand-lg bg-white fixed-top">
                <a class="navbar-brand" href="rapport.html">DUEN-HOTEL</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse"
                    data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
              
                <div class="collapse navbar-collapse " id="navbarSupportedContent">
                    <ul class="navbar-nav ml-auto navbar-right-top">

                        <li class="" style=" width: 100%; margin-right: 10px;">
                            <a class="nav-link nav-icons"><button
                                    style="width: 100%; background-color: #b35100; border-radius: 50%;"
                                    class="fas fa-fw fa-user" id="UserName"></button> </a>

                        </li>
                        <li class="" style=" width: 100%; margin-right: 10px;">
                            <a class="nav-link nav-icons" href="home.html"><button style="width: 100%;"
                                    class="fas fa-fw fa-circle">Accueil</button> </a>

                        </li>



                    </ul>

                </div>
            </nav>
        </div>
        <!-- ============================================================== -->
        <!-- end navbar -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- left sidebar -->
        <!-- ============================================================== -->
       
        <style>
            #invoices li {
                font-size: 18px;
                margin-top: 10px;
            }
        </style>
        <!-- ============================================================== -->
        <!-- end left sidebar -->
        <!-- ============================================================== -->
        <!-- wrapper  -->
        <!-- ============================================================== -->
        <div class="dashboard-expanded">
            <div class="influence-profile">
                <div class="container-fluid dashboard-content ">
                    <!-- ============================================================== -->
                    <!-- pageheader -->
                    <!-- ============================================================== -->
                    <div class="row">
                        <div class="col-xl-8 col-lg-8 col-md-8 col-sm-8 col-8">
                            <div class="page-header">
                                <h3 class="mb-2">ORDER Dashboard </h3>
                                <p class="pageheader-text">Proin placerat ante duiullam scelerisque a velit ac porta,
                                    fusce sit amet vestibulum mi. Morbi lobortis pulvinar quam.</p>
                                <div class="page-breadcrumb">
                                    <nav aria-label="breadcrumb">
                                        <ol class="breadcrumb">
                                            <li class="breadcrumb-item"><a href="#"
                                                    class="breadcrumb-link">Dashboard</a></li>
                                            <li class="breadcrumb-item active" aria-current="page">Duen-Hotel Sale</li>
                                        </ol>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                    <style>

                    </style>
                    <!-- ============================================================== -->
                    <!-- end pageheader -->
                    <!-- ============================================================== -->


                    <div class="row col-xl-12" style="width: 100%;">


                        <div class="col-xl-12">
                            <div class="card" style="width: 100%;">
                                <button id="print" class="newcustomer" onclick="generatePDFDetails();"
                                    type="button">Print Repport</button>
                                <div class="card-body">

                                    <div class="metric-value d-inline-block" id="repportgene"><br><br><br><br>
                                        <center> <input type="date" id="daterepport" style="font-size:30px;" required
                                                readonly>
                                            <h3 id="userrepport"></h3>
                                        </center>

                                        <div style="margin-top: 30px; margin-left: 30px;" id="resultsContainer"></div>

                                    </div>
                                    <div class="metric-label d-inline-block float-right text-success font-weight-bold">
                                        <span class="icon-circle-small icon-box-xs text-success bg-success-light"><i
                                                class="fa fa-fw fa-arrow-up"></i></span><span class="ml-1">25%</span>
                                    </div>
                                </div>
                                <div class="card-body bg-light p-t-40 p-b-40">
                                    <div id="sparkline-revenue3"></div>
                                    <div id="listperpayment"></div>
                                </div>

                                <div class="card-footer text-center bg-white">
                                    <a href="#" class="card-link">View Details</a>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </div>

        </div>

    </div>


    <!-- ============================================================== -->
    <!-- end wrapper -->
    <!-- ============================================================== -->
    </div>



    <!-- Ajoutez ces scripts avant la fermeture de la balise body -->

    <script src="https://konbitmarket.netlify.app/js/js/firebase-app.js"></script>
    <script src="https://konbitmarket.netlify.app/js/js/auth.js"></script>
    <script src="https://konbitmarket.netlify.app/js/js/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>



    <script>
        // Get current date
        const today = new Date();

        // Format date to 'YYYY-MM-DD' (required by HTML date input)
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}`;

    
    </script>

    <script>
        // Set the value of the input field to the current date

        document.getElementById('daterepport').value = formattedDate;
       
    </script>

    <script>
        // Format time to 'HH:MM' (required by HTML time input)
        const hours = String(today.getHours()).padStart(2, '0');
        const minutes = String(today.getMinutes()).padStart(2, '0');
        const formattedTime = `${hours}:${minutes}`;

    </script>




    <script src="htmltopdf.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

    <script>
        function generatePDF() {
            const element = document.getElementById('myForm');

            // Options pour la conversion en PDF
            const options = {
                margin: 0,
                filename: 'order.pdf',
                image: {
                    type: 'jpeg',
                    quality: 1
                }, // Augmenter la qualité de l'image
                html2canvas: {
                    scale: 2
                }, // Augmenter l'échelle
                jsPDF: {
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'portrait'
                }
            };

            // Conversion de l'élément en PDF
            html2pdf()
                .from(element)
                .set(options)
                .save();
        }
    </script>


    <script>
        function generatePDFDetails() {
            const element = document.getElementById('repportgene');

            // Options pour la conversion en PDF
            const options = {
                margin: 0,
                filename: 'order.pdf',
                image: {
                    type: 'jpeg',
                    quality: 1
                }, // Augmenter la qualité de l'image
                html2canvas: {
                    scale: 2
                }, // Augmenter l'échelle
                jsPDF: {
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'portrait'
                }
            };

            // Conversion de l'élément en PDF
            html2pdf()
                .from(element)
                .set(options)
                .save();
        }
    </script>






    <script>
        // Vérifier si l'utilisateur est connecté
        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                // Utilisateur connecté
                const userId = user.uid;

                // Récupérer le nom de l'utilisateur à partir de la collection 'users'
                db.collection('users').doc(userId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const userData = doc.data();
                            const sellerNameInput = document.getElementById('sellerName');
                            const UserName = document.getElementById('UserName');
                            const UserName1 = document.getElementById('userrepport');
                            UserName.textContent = userData.name;
                            UserName1.textContent = userData.name;
                            if (sellerNameInput) {
                                sellerNameInput.value = userData.name; // Remplir l'input avec le nom de l'utilisateur
                            }
                        } else {
                            console.error('Aucun document trouvé pour cet utilisateur.');
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de la récupération des données de l\'utilisateur:', error);
                    });
            } else {
                // Utilisateur non connecté, rediriger vers la page d'index
                window.location.href = 'index.html';
            }
        });
    </script>



 

    <script>
               // Fonction pour récupérer l'utilisateur connecté
                function getCurrentUser() {
                    const user = firebase.auth().currentUser;
                    if (user) {
                        return db.collection('users').doc(user.uid).get()
                            .then(function (doc) {
                                if (doc.exists) {
                                    return doc.data().name;
                                } else {
                                    throw new Error("No such document!");
                                }
                            })
                            .catch(function (error) {
                                console.error("Error getting document: ", error);
                            });
                    } else {
                        return Promise.reject(new Error("No user is currently logged in."));
                    }
                }
        // Fonction pour récupérer les ventes en fonction de la date sélectionnée et afficher les totaux par jour avec la liste des produits et le grand total pour chaque collection
        function filterSalesByDate() {
            const selectedDate = document.getElementById('daterepport').value; // Récupérer la date sélectionnée dans l'input

            // Si aucune date n'est sélectionnée, afficher un message d'erreur ou une notification à l'utilisateur
            if (!selectedDate) {
                alert('Veuillez sélectionner une date.');
                return;
            }

            // Récupérer l'utilisateur connecté
            getCurrentUser().then(function (currentUserName) {
                // Définir les catégories disponibles
                const categories = ['drink', 'food', 'room', 'spec18', 'pool', 'smoke'];

                // Initialiser l'objet pour stocker les totaux par article, par catégorie et par devise
                const totalsByItemCategoryAndCurrency = [];
                const salesData = [];

                // Récupérer la collection de ventes pour la date sélectionnée et le vendeur connecté
                db.collection('globalSales')
                    .where("date", "==", selectedDate)
                    .where("sellerName", "==", currentUserName)
                    .get()
                    .then(function (querySnapshot) {
                        querySnapshot.forEach(function (doc) {
                            const data = doc.data();
                            salesData.push(data);
                            const products = data.products;

                            // Parcourir les produits de cette vente
                            products.forEach(function (product) {
                                const category = product.category;
                                const currency = product.currency;
                                const quantity = parseInt(product.quantity);
                                const price = parseFloat(product.price);
                                const revenue = quantity * price;

                                // Vérifier si la catégorie est une catégorie valide
                                if (categories.includes(category)) {
                                    // Si la catégorie n'existe pas encore dans les totaux, l'initialiser
                                    if (!totalsByItemCategoryAndCurrency.hasOwnProperty(category)) {
                                        totalsByItemCategoryAndCurrency[category] = {
                                            Gdes: {},
                                            Us: {}
                                        };
                                    }

                                    // Vérifier si l'article existe déjà dans la devise spécifiée
                                    const itemKey = product.item.toLowerCase(); // Utiliser le nom de l'article comme clé, en minuscules pour éviter les doublons
                                    if (!totalsByItemCategoryAndCurrency[category][currency].hasOwnProperty(itemKey)) {
                                        // Si l'article n'existe pas encore, l'initialiser avec la quantité et le revenu actuels
                                        totalsByItemCategoryAndCurrency[category][currency][itemKey] = {
                                            totalQuantity: quantity,
                                            totalRevenue: revenue
                                        };
                                    } else {
                                        // Si l'article existe déjà, mettre à jour la quantité et le revenu
                                        totalsByItemCategoryAndCurrency[category][currency][itemKey].totalQuantity += quantity;
                                        totalsByItemCategoryAndCurrency[category][currency][itemKey].totalRevenue += revenue;
                                    }
                                }
                            });
                        });

                        // Afficher les totaux par catégorie, par article et par devise
                        displayTotalSalesByCategoryAndCurrency(totalsByItemCategoryAndCurrency, salesData);
                    })
                    .catch(function (error) {
                        console.error('Error getting documents: ', error);
                    });
            }).catch(function (error) {
                console.error('Error getting current user: ', error);
                alert('Veuillez vous connecter pour afficher les ventes.');
            });
        }

        // Fonction pour afficher les totaux par catégorie, par article et par devise
        function displayTotalSalesByCategoryAndCurrency(totalsByItemCategoryAndCurrency, salesData) {
            const resultContainer = document.getElementById('resultsContainer');
            resultContainer.innerHTML = ''; // Effacer le contenu précédent

            // Variables pour stocker les totaux par méthode de paiement
            const paymentMethodTotals = {};
            const paymentStatusTotals = {
                PAYE: {
                    totalGdes: 0,
                    totalUs: 0
                },
                NONPAYE: {
                    totalGdes: 0,
                    totalUs: 0
                },
                CREDIT: {
                    totalGdes: 0,
                    totalUs: 0
                }
            };

            // Générer le contenu HTML pour les totaux par catégorie, par article et par devise
            let html = '<h3>Rapport Du Jour</h3>';

            // Boucle à travers chaque catégorie
            for (const category in totalsByItemCategoryAndCurrency) {
                if (totalsByItemCategoryAndCurrency.hasOwnProperty(category)) {
                    html += `<h4>${category}:</h4>`;

                    html += '<table border="1" cellpadding="5" cellspacing="0">';
                    html += '<thead>';
                    html += '<tr>';
                    html += '<th>Item</th>';
                    html += '<th>Quantity Gdes</th>';
                    html += '<th>Revenu Gdes</th>';
                    html += '<th>Quantity Us</th>';
                    html += '<th>Revenu Us</th>';
                    html += '</tr>';
                    html += '</thead>';
                    html += '<tbody>';

                    let totalGdes = 0;
                    let totalUs = 0;

                    const itemsProcessed = new Set();

                    // Afficher les produits en Gdes et calculer le total
                    for (const item in totalsByItemCategoryAndCurrency[category].Gdes) {
                        if (totalsByItemCategoryAndCurrency[category].Gdes.hasOwnProperty(item)) {
                            const totalGdesData = totalsByItemCategoryAndCurrency[category].Gdes[item];
                            const totalUsData = totalsByItemCategoryAndCurrency[category].Us[item] || {
                                totalQuantity: 0,
                                totalRevenue: 0
                            };

                            html += '<tr>';
                            html += `<td>${item}</td>`;
                            html += `<td>${totalGdesData.totalQuantity}</td>`;
                            html += `<td>${totalGdesData.totalRevenue}</td>`;
                            html += `<td>${totalUsData.totalQuantity}</td>`;
                            html += `<td>${totalUsData.totalRevenue}</td>`;
                            html += '</tr>';

                            totalGdes += totalGdesData.totalRevenue;
                            totalUs += totalUsData.totalRevenue;
                            itemsProcessed.add(item);
                        }
                    }

                    // Afficher les produits en Us qui n'ont pas de correspondance en Gdes
                    for (const item in totalsByItemCategoryAndCurrency[category].Us) {
                        if (totalsByItemCategoryAndCurrency[category].Us.hasOwnProperty(item) && !itemsProcessed.has(item)) {
                            const totalUsData = totalsByItemCategoryAndCurrency[category].Us[item];

                            html += '<tr>';
                            html += `<td>${item}</td>`;
                            html += `<td>${totalUsData.totalQuantity}</td>`;
                            html += `<td>0</td>`;
                            html += `<td>${totalUsData.totalRevenue}</td>`;
                            html += '</tr>';

                            totalUs += totalUsData.totalRevenue;
                        }
                    }

                    html += '</tbody>';
                    html += '<tfoot>';
                    html += `<tr><td colspan="2"><strong>Total</strong></td><td><strong>${totalGdes}</strong></td><td><strong>${totalUs}</strong></td></tr>`;
                    html += '</tfoot>';
                    html += '</table><br><br>';
                }
            }

            // Calculer les totaux par méthode de paiement et par statut de paiement à partir des données de vente (salesData)
            salesData.forEach(sale => {
                const paymentMethod = sale.paymentmeth;
                const paymentStatus = sale.paymentStatut;
                const totalGdes = sale.totalGdes || 0;
                const totalUs = sale.totalUs || 0;

                if (paymentMethod) {
                    if (!paymentMethodTotals[paymentMethod]) {
                        paymentMethodTotals[paymentMethod] = {
                            totalGdes: 0,
                            totalUs: 0
                        };
                    }
                    paymentMethodTotals[paymentMethod].totalGdes += totalGdes;
                    paymentMethodTotals[paymentMethod].totalUs += totalUs;
                }

                if (paymentStatus) {
                    if (!paymentStatusTotals[paymentStatus]) {
                        paymentStatusTotals[paymentStatus] = {
                            totalGdes: 0,
                            totalUs: 0
                        };
                    }
                    paymentStatusTotals[paymentStatus].totalGdes += totalGdes;
                    paymentStatusTotals[paymentStatus].totalUs += totalUs;
                }
            });

            // Afficher les totaux par méthode de paiement
            html += '<h3>Totaux par Méthode de Paiement</h3>';
            for (const paymentMethod in paymentMethodTotals) {
                if (paymentMethodTotals.hasOwnProperty(paymentMethod)) {
                    html += `<p>${paymentMethod}: Total Gdes - ${paymentMethodTotals[paymentMethod].totalGdes}, Total Us - ${paymentMethodTotals[paymentMethod].totalUs}</p>`;
                }
            }

            // Afficher les totaux par statut de paiement
            html += '<h3>Totaux par Statut de Paiement</h3>';
            for (const paymentStatus in paymentStatusTotals) {
                if (paymentStatusTotals.hasOwnProperty(paymentStatus)) {
                    html += `<p>${paymentStatus}: Total Gdes - ${paymentStatusTotals[paymentStatus].totalGdes}, Total Us - ${paymentStatusTotals[paymentStatus].totalUs}</p>`;
                }
            }

            // Insérer le contenu dans l'élément "resultContainer"
            resultContainer.innerHTML = html;
        }

        // Attendre que Firebase Auth soit prêt avant d'ajouter l'écouteur d'événement
        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                // Appeler la fonction pour filtrer les ventes par date lorsqu'une date est sélectionnée
                document.getElementById("daterepport").addEventListener("change", filterSalesByDate);
                // Appeler la fonction pour filtrer les ventes par date lors du chargement de la page
                filterSalesByDate();

            } else {
                alert('Veuillez vous connecter pour afficher les ventes.');
            }
        });
    </script>

 


</body>

</html>